SELECT
  line1.osm_id AS line1_id, line1.osm_type AS line1_type, 
  line2.osm_id AS line2_id, line2.osm_type AS line2_type, 
  line3.osm_id AS line3_id, line3.osm_type AS line3_type
FROM linestrings AS line1, linestrings AS line2, linestrings AS line3
WHERE line1.category = 'walkway' AND line1.tags->>'surface' = 'concrete' AND line2.category = 'walkway' AND line3.category = 'walkway' AND line3.osm_id != line2.osm_id AND line3.osm_id != line1.osm_id AND line2.osm_id != line1.osm_id AND ST_DWithin(line1.geom, line2.geom, 30) AND ST_DWithin(line1.geom, line3.geom, 20) AND 
(
  (
    abs((
      degrees(ST_Azimuth(ST_StartPoint(line2.geom), ST_EndPoint(line2.geom)))
      -
      degrees(ST_Azimuth(ST_StartPoint(line1.geom), ST_EndPoint(line1.geom)))
    )::decimal % 180.0) BETWEEN 75 AND 85
  ) 
  OR
  (
    abs((
      degrees(ST_Azimuth(ST_StartPoint(line2.geom), ST_EndPoint(line2.geom)))
      -
      degrees(ST_Azimuth(ST_StartPoint(line1.geom), ST_EndPoint(line1.geom)))
    )::decimal % 180.0) BETWEEN 95 AND 105
  ) 
)
 AND 
(
  (
    abs((
      degrees(ST_Azimuth(ST_StartPoint(line3.geom), ST_EndPoint(line3.geom)))
      -
      degrees(ST_Azimuth(ST_StartPoint(line1.geom), ST_EndPoint(line1.geom)))
    )::decimal % 180.0) BETWEEN 42 AND 48
  ) 
  OR
  (
    abs((
      degrees(ST_Azimuth(ST_StartPoint(line3.geom), ST_EndPoint(line3.geom)))
      -
      degrees(ST_Azimuth(ST_StartPoint(line1.geom), ST_EndPoint(line1.geom)))
    )::decimal % 180.0) BETWEEN 132 AND 138
  ) 
)
 AND 
(
  (
    abs((
      degrees(ST_Azimuth(ST_StartPoint(line3.geom), ST_EndPoint(line3.geom)))
      -
      degrees(ST_Azimuth(ST_StartPoint(line2.geom), ST_EndPoint(line2.geom)))
    )::decimal % 180.0) BETWEEN 42 AND 48
  ) 
  OR
  (
    abs((
      degrees(ST_Azimuth(ST_StartPoint(line3.geom), ST_EndPoint(line3.geom)))
      -
      degrees(ST_Azimuth(ST_StartPoint(line2.geom), ST_EndPoint(line2.geom)))
    )::decimal % 180.0) BETWEEN 132 AND 138
  ) 
)
;
